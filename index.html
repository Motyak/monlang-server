<script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>

<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">

<link href="https://cdn.jsdelivr.net/npm/monaco-editor@0.52.2/min/vs/editor/editor.main.css" rel="stylesheet">

<title>src.ml</title>

<!--
`min-w-0` => to prevent `flex-1 w-full` from expanding beyond its parent (viewport)
`min-h-0` => to prevent `flex-1 h-full` from expanding beyond its parent (viewport)
-->

<div id="globalpanel" class="flex flew-row w-screen h-screen font-mono">
    <div id="sidepanel" class="flex-none w-1/5 h-full border-r-2 border-gray-300 text-sm">
        <div id="LV1_panel" class="flex flex-col flex-1 w-full h-1/2">
            <h1 class="font-bold text-center border-t border-l border-gray-400">LV1 SYNTAX TREE</h1>
            <div id="LV1_tree" class="h-full overflow-x-auto overflow-y-auto border-t border-gray-200">
                <table class="w-full">
                </table>
            </div>
        </div>
        <div id="LV2_panel" class="flex flex-col flex-1 w-full h-1/2">
            <h1 class="font-bold text-center border-t border-l border-gray-400">LV2 SYNTAX TREE</h1>
            <div id="LV2_tree" class="h-full overflow-x-auto overflow-y-auto border-t border-gray-200">
                <table class="w-full">
                </table>
            </div>
        </div>
    </div>
    <div id="mainpanel" class="flex flex-col flex-1 w-full h-full min-w-0">
        <div id="editorpanel" class="flex-1 w-full h-full min-h-0"></div>
        <div id="consolepanel" class="flex flex-col w-full h-1/3 border-t-2 border-gray-300">
            <pre id="prog_out" class="flex-1 overflow-y-auto">&lt;prog_out&gt;</pre>
            <p id="prog_status" class="truncate border-t border-gray-400">&lt;prog_status&gt;</p>
        </div>
    </div>
</div>

<script>
    let editor; // forward declaration
</script>

<script type="module">
    import * as monaco from "https://cdn.jsdelivr.net/npm/monaco-editor@0.52.2/+esm";

    const editor_conf = {
        automaticLayout: true,
        lineNumbersMinChars: 3,
    }
    editor = monaco.editor.create($("#editorpanel")[0], editor_conf);
</script>

<script>
    let g_lastExecutedSrc = ""
    let g_sidePanelState = 0

    // line and col starts at 1
    const jump_to = (line, col) => {
        editor.revealLineInCenter(line)
        editor.setPosition({lineNumber: line, column: col})
        editor.focus()
    }

    const addLinksInConsole = () => {
        const asLink = (filename, line, col) => {
            return `<span onclick="jump_to(${line}, ${col})" `
                + `class="text-blue-600 cursor-pointer underline hover:text-blue-800 hover:no-underline"`
                + `>${filename}:${line}:${col}</span>`
        }

        $("#prog_out").html((_index, html) => {
            return html.replace(
                /\b(src\.ml):([1-9][0-9]*):([1-9][0-9]*)\b/g,
                (_match, filename, line, col) => asLink(filename, line, col)
            )
        })
    }

    // get indentation of an AST node (table <tr> or .ast.txt line)
    const get_indent = arg => {
        if (typeof arg === 'string') {
            return arg.search(/[▾▸\s]\s[^▾▸\s]/)
        }
        // otherwise => it's a <tr>
        return $(arg).find("pre:first").text().search(/[▾▸\s]\s[^▾▸\s]/)
    }

    const toggleSyntaxTreeNode = tr => {
        const collapse = tr => {
            let tr_pre = $(tr).find("pre:first")
            let tr_pre_text = tr_pre.text()

            $(tr_pre).text(tr_pre_text.replace(/▾/, "▸"))

            let indent = get_indent(tr)
            $(tr)
                .nextUntil((_index, element) => get_indent(element) <= indent)
                .each((_index, element) => $(element).hide())

            $(tr).addClass("bg-gray-200")
        }

        const expand = tr => {
            let tr_pre = $(tr).find("pre:first")
            let tr_pre_text = tr_pre.text()

            $(tr_pre).text(tr_pre_text.replace(/▸/, "▾"))

            let indent = get_indent(tr)
            let collapsed_parent = false
            let collapsed_parent_indent = 0
            $(tr)
                .nextUntil((_index, element) => get_indent(element) <= indent)
                 .each((_index, element) => {
                    if (collapsed_parent) {
                        if (get_indent(element) <= collapsed_parent_indent) {
                            /* reset variables */
                            collapsed_parent = false
                            collapsed_parent_indent = 0
                        }
                        else {
                            return // don't show it
                        }
                    }

                    if ($(element).text().match(/^\s*▸/)) {
                        /* setup variables for next iterations */
                        collapsed_parent = true
                        collapsed_parent_indent = get_indent(element)
                    }

                    $(element).show()
                })

            $(tr).removeClass("bg-gray-200")
        }

        let tr_pre_text = $(tr).find("pre:first").text()
        if (tr_pre_text.match(/^\s*▾/)) {
            collapse(tr)
        }
        else if (tr_pre_text.match(/^\s*▸/)) {
            expand(tr)
        }
        else {
            ; // standalone node => nothing to do
        }
    }

    const get_src = () => editor.getValue()
    const set_src = src => editor.setValue(src)

    const get_res = () => $("#prog_out").text()
    const set_res = res => {
        const res_obj = JSON.parse(res)
        console.log(res_obj)

        /* set console panel */
        if (res_obj["prog"] === "interpreter") {
            let exitcode = res_obj["prog_exitcode"]
            $("#prog_out").text(res_obj["out"]["console.txt"])
            addLinksInConsole()
            $("#prog_status").text(`Program terminated with exit code ${exitcode}`)
            $("#prog_status").css("border-top-color", exitcode === 0? "green" : "red")
            $("#prog_status").show()
        }
        else if (res_obj["prog"] === "parser") {
            $("#prog_out").text(res_obj["out"]["traceback.txt"])
            addLinksInConsole()
            $("#prog_status").hide()
        }
        $("#consolepanel").show()

        setTimeout(() => {
            /* set LV1_tree */
            $("#LV1_tree table").empty()
            let LV1_lines = res_obj["out"]["LV1.ast.txt"].split("\n")
            for (let i = 0; i < LV1_lines.length; ++i) {
                let prefix = (
                    i + 1 == LV1_lines.length
                    || get_indent(LV1_lines[i + 1]) <= get_indent(LV1_lines[i])
                )? "  " : "▾ "
                // /!\ the "prefix" is set after the indentation
                let prefixedLine = LV1_lines[i].replace(/(\S)/, (_match, group) => prefix + group)
                let newRow = `<tr onclick="toggleSyntaxTreeNode(this)" `
                        + `class="select-none cursor-pointer hover:bg-gray-100">`
                        +`<td><pre class="text-xs">`
                        + prefixedLine
                        + `</pre></td></tr>`
                $("#LV1_tree table").append(newRow)
            }

            /* set LV2_tree */
            $("#LV2_tree table").empty()
            let LV2_lines = res_obj["out"]["LV2.ast.txt"].split("\n")
            for (let i = 0; i < LV2_lines.length; ++i) {
                let prefix = (
                    i + 1 == LV2_lines.length
                    || get_indent(LV2_lines[i + 1]) <= get_indent(LV2_lines[i])
                )? "  " : "▾ "
                // /!\ the "prefix" is set after the indentation
                let prefixedLine = LV2_lines[i].replace(/(\S)/, (_match, group) => prefix + group)
                let newRow = `<tr onclick="toggleSyntaxTreeNode(this)" `
                        + `class="select-none cursor-pointer hover:bg-gray-100">`
                        +`<td><pre class="text-xs">`
                        + prefixedLine
                        + `</pre></td></tr>`
                $("#LV2_tree table").append(newRow)
            }
        }, 0)
    }

    const execute_src = (src = get_src(), onSuccess = set_res) => {
        const clearConsole = () => {
            $("#prog_out").text("")
            $("#prog_status").text("Executing program...")
            $("#prog_status").css("border-top-color", "grey")
            $("#prog_status").show()
        }
        // 20ms is the min delay above which you don't see an ugly blink..
        // ..when executing the simplest `print($true)` program
        // 100ms is the max delay below which you don't perceive..
        // ..a latency between pressing ctrl+S and seeing the console clear
        const timeout_clearConsole = setTimeout(clearConsole, 100)

        const formData = new FormData()
        formData.append("src", new Blob([src]), "src.ml")
        $.post({
            data: formData,
            contentType: false,
            processData: false,
            success: res => {
                clearTimeout(timeout_clearConsole)
                onSuccess(res)
            },
            error: console.error
        })
    }

    $(document).ready(() => {
        $(document).keydown(event => {
            if (event.ctrlKey && event.key === "s") {
                event.preventDefault()
                let src = get_src()
                execute_src(src)
                g_lastExecutedSrc = src
                document.title = "src.ml"
            }

            if (event.ctrlKey && event.key === "j") {
                event.preventDefault()
                $("#consolepanel").toggle()
            }

            if (event.ctrlKey && event.key === "b") {
                event.preventDefault()
                switch (g_sidePanelState) {
                    case 0: {
                        $("#LV1_panel").hide()
                        $("#LV2_panel").hide()
                        g_sidePanelState = 1
                        break
                    }
                    case 1: {
                        $("#sidepanel").hide()
                        g_sidePanelState = 2
                        break
                    }
                    case 2: {
                        $("#LV1_panel").show()
                        $("#LV2_panel").show()
                        $("#sidepanel").show()
                        g_sidePanelState = 0
                        break
                    }
                }
            }
        })

        editor.getModel().onDidChangeContent(_event => {
            document.title = get_src() === g_lastExecutedSrc? "src.ml" : "*src.ml"
        })
    })
</script>
